<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ç´§å‡‘çº§è½¦è¯•é©¾æ•°æ®æ”¶é›†å·¥å…·</title>
    <meta name="description" content="ä¸“ä¸šçš„ç´§å‡‘çº§è½¦è¯•é©¾æ•°æ®æ”¶é›†å’Œå¯¹æ¯”å·¥å…·" />
    <meta name="theme-color" content="#2196f3" />
    <link rel="manifest" href="manifest.json" />
    <link rel="apple-touch-icon" href="icons/icon-192x192.png" />
    <style>
      :root {
        --primary-color: #2196f3;
        --secondary-color: #03a9f4;
        --accent-color: #ff9800;
        --text-color: #333333;
        --background-color: #f5f5f5;
        --card-color: #ffffff;
        --border-color: #e0e0e0;
      }

      [data-theme="dark"] {
        --primary-color: #1976d2;
        --secondary-color: #0288d1;
        --accent-color: #ffb74d;
        --text-color: #f5f5f5;
        --background-color: #121212;
        --card-color: #1e1e1e;
        --border-color: #333333;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
      }

      body {
        background-color: var(--background-color);
        color: var(--text-color);
        line-height: 1.6;
        transition: all 0.3s ease;
        padding-bottom: 70px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 15px;
      }

      header {
        background-color: var(--primary-color);
        color: white;
        padding: 15px 0;
        position: sticky;
        top: 0;
        z-index: 1000;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .logo h1 {
        font-size: 1.5rem;
        font-weight: 600;
      }

      .nav-buttons button {
        background-color: rgba(255, 255, 255, 0.2);
        border: none;
        padding: 8px 12px;
        border-radius: 4px;
        color: white;
        font-size: 0.9rem;
        cursor: pointer;
        margin-left: 8px;
        transition: background-color 0.3s;
      }

      .nav-buttons button:hover {
        background-color: rgba(255, 255, 255, 0.3);
      }

      main {
        padding: 20px 0;
      }

      .card {
        background-color: var(--card-color);
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
        padding: 20px;
      }

      .card-title {
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 15px;
        color: var(--primary-color);
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 10px;
      }

      .form-group {
        margin-bottom: 15px;
      }

      label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
      }

      input[type="text"],
      input[type="number"],
      input[type="date"],
      select,
      textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        background-color: var(--background-color);
        color: var(--text-color);
        font-size: 1rem;
      }

      textarea {
        min-height: 100px;
        resize: vertical;
      }

      .rating-container {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .rating-slider {
        flex-grow: 1;
        height: 10px;
        -webkit-appearance: none;
        appearance: none;
        background: linear-gradient(to right, #ff5252, #ffeb3b, #4caf50);
        border-radius: 5px;
      }

      .rating-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: var(--primary-color);
        cursor: pointer;
      }

      .rating-value {
        width: 30px;
        text-align: center;
        font-weight: bold;
      }

      .media-buttons {
        display: flex;
        gap: 10px;
        margin-top: 10px;
      }

      .media-button {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 8px 15px;
        background-color: var(--secondary-color);
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: background-color 0.3s;
      }

      .media-button:hover {
        background-color: var(--primary-color);
      }

      .media-button i {
        margin-right: 5px;
      }

      .media-preview {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 10px;
      }

      .media-item {
        width: 100px;
        height: 100px;
        border-radius: 4px;
        overflow: hidden;
        position: relative;
      }

      .media-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .media-item .delete-btn {
        position: absolute;
        top: 5px;
        right: 5px;
        background-color: rgba(244, 67, 54, 0.7);
        color: white;
        border: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .action-buttons {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 20px;
      }

      .action-button {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        font-size: 1rem;
        cursor: pointer;
        transition: background-color 0.3s;
      }

      .primary-button {
        background-color: var(--primary-color);
        color: white;
      }

      .primary-button:hover {
        background-color: var(--secondary-color);
      }

      .secondary-button {
        background-color: var(--border-color);
        color: var(--text-color);
      }

      .secondary-button:hover {
        background-color: #d5d5d5;
      }

      .tab-container {
        display: flex;
        border-bottom: 1px solid var(--border-color);
        margin-bottom: 20px;
      }

      .tab {
        padding: 10px 20px;
        cursor: pointer;
        border-bottom: 2px solid transparent;
        transition: all 0.3s;
      }

      .tab.active {
        border-bottom-color: var(--primary-color);
        color: var(--primary-color);
        font-weight: 500;
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      .advantage-disadvantage {
        display: flex;
        gap: 15px;
        margin-top: 10px;
      }

      .advantage-container,
      .disadvantage-container {
        flex: 1;
      }

      .tag-container {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 8px;
      }

      .tag {
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .advantage-tag {
        background-color: rgba(76, 175, 80, 0.1);
        color: #4caf50;
        border: 1px solid #4caf50;
      }

      .disadvantage-tag {
        background-color: rgba(244, 67, 54, 0.1);
        color: #f44336;
        border: 1px solid #f44336;
      }

      .tag .delete-tag {
        cursor: pointer;
        font-size: 0.8rem;
      }

      .add-tag-input {
        display: flex;
        gap: 5px;
        margin-top: 8px;
      }

      .add-tag-input input {
        flex-grow: 1;
        padding: 8px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        font-size: 0.9rem;
      }

      .add-tag-input button {
        padding: 8px 12px;
        background-color: var(--primary-color);
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s;
      }

      .add-tag-input button:hover {
        background-color: var(--secondary-color);
      }

      .footer-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background-color: var(--card-color);
        box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
        display: flex;
        justify-content: space-around;
        padding: 10px 0;
        z-index: 1000;
      }

      .nav-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        color: var(--text-color);
        text-decoration: none;
        font-size: 0.8rem;
      }

      .nav-item i {
        font-size: 1.5rem;
        margin-bottom: 3px;
      }

      .nav-item.active {
        color: var(--primary-color);
      }

      /* Car comparison styles */
      .comparison-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        overflow-x: auto;
      }

      .comparison-table th,
      .comparison-table td {
        padding: 10px;
        border: 1px solid var(--border-color);
        text-align: left;
      }

      .comparison-table th {
        background-color: var(--secondary-color);
        color: white;
        font-weight: 500;
      }

      .comparison-table tr:nth-child(even) {
        background-color: rgba(0, 0, 0, 0.03);
      }

      .car-select-container {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 20px;
      }

      .car-select-item {
        padding: 8px 15px;
        background-color: var(--card-color);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s;
      }

      .car-select-item.selected {
        background-color: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
      }

      /* Radar chart container */
      .radar-chart-container {
        width: 100%;
        height: 400px;
        margin-top: 20px;
      }

      /* Modal styles */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 2000;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .modal-content {
        background-color: var(--card-color);
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        width: 100%;
        max-width: 500px;
        max-height: 90vh;
        overflow-y: auto;
        padding: 20px;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid var(--border-color);
      }

      .modal-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: var(--primary-color);
      }

      .modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: var(--text-color);
      }

      .modal-body {
        margin-bottom: 20px;
      }

      .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        padding-top: 10px;
        border-top: 1px solid var(--border-color);
      }

      /* Responsive adjustments */
      @media (max-width: 768px) {
        .advantage-disadvantage {
          flex-direction: column;
        }

        .header-content .logo h1 {
          font-size: 1.2rem;
        }

        .nav-buttons button {
          padding: 6px 10px;
          font-size: 0.8rem;
        }
      }

      @media (max-width: 480px) {
        .card {
          padding: 15px;
        }

        .card-title {
          font-size: 1.1rem;
        }

        .action-button {
          padding: 8px 15px;
          font-size: 0.9rem;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <div class="container header-content">
        <div class="logo">
          <h1>ç´§å‡‘çº§è½¦è¯•é©¾æ•°æ®æ”¶é›†</h1>
        </div>
        <div class="nav-buttons">
          <button id="toggleTheme">åˆ‡æ¢ä¸»é¢˜</button>
          <button id="exportData">å¯¼å‡ºæ•°æ®</button>
        </div>
      </div>
    </header>

    <main class="container">
      <div id="homeView" class="view active">
        <div class="card">
          <div class="card-title">æˆ‘çš„è¯•é©¾è®°å½•</div>
          <div id="carList" class="car-list">
            <!-- è½¦è¾†åˆ—è¡¨å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
          </div>
          <div class="action-buttons">
            <button class="action-button primary-button" id="addNewCarBtn">
              æ·»åŠ æ–°è½¦å‹
            </button>
          </div>
        </div>
      </div>

      <div id="recordView" class="view" style="display: none">
        <div class="card">
          <div class="card-title">è½¦è¾†åŸºæœ¬ä¿¡æ¯</div>
          <form id="carInfoForm">
            <div class="form-group">
              <label for="carBrand">å“ç‰Œ</label>
              <input type="text" id="carBrand" name="carBrand" required />
            </div>
            <div class="form-group">
              <label for="carModel">è½¦å‹</label>
              <input type="text" id="carModel" name="carModel" required />
            </div>
            <div class="form-group">
              <label for="carTrim">é…ç½®ç‰ˆæœ¬</label>
              <input type="text" id="carTrim" name="carTrim" />
            </div>
            <div class="form-group">
              <label for="msrp">å®˜æ–¹æŒ‡å¯¼ä»·(ä¸‡å…ƒ)</label>
              <input type="number" id="msrp" name="msrp" step="0.01" />
            </div>
            <div class="form-group">
              <label for="dealerPrice">å®é™…æŠ¥ä»·(ä¸‡å…ƒ)</label>
              <input
                type="number"
                id="dealerPrice"
                name="dealerPrice"
                step="0.01"
              />
            </div>
            <div class="form-group">
              <label for="testDriveDate">è¯•é©¾æ—¥æœŸ</label>
              <input type="date" id="testDriveDate" name="testDriveDate" />
            </div>
            <div class="form-group">
              <label for="testDriveLocation">è¯•é©¾åœ°ç‚¹</label>
              <input
                type="text"
                id="testDriveLocation"
                name="testDriveLocation"
              />
            </div>
            <div class="form-group">
              <label for="salesContact">é”€å”®é¡¾é—®è”ç³»æ–¹å¼</label>
              <input type="text" id="salesContact" name="salesContact" />
            </div>
          </form>
        </div>

        <div class="card">
          <div class="card-title">è¯„æµ‹æ•°æ®</div>
          <div class="tab-container">
            <div class="tab active" data-tab="exterior">å¤–è§‚</div>
            <div class="tab" data-tab="interior">å†…é¥°</div>
            <div class="tab" data-tab="space">ç©ºé—´</div>
            <div class="tab" data-tab="driving">é©¾é©¶ä½“éªŒ</div>
            <div class="tab" data-tab="nvh">å™ªéŸ³æ§åˆ¶</div>
            <div class="tab" data-tab="smart">æ™ºèƒ½ç³»ç»Ÿ</div>
          </div>

          <div id="exteriorTab" class="tab-content active">
            <div class="form-group">
              <label>æ•´ä½“è®¾è®¡æ„Ÿ</label>
              <div class="rating-container">
                <input
                  type="range"
                  class="rating-slider"
                  min="1"
                  max="10"
                  value="5"
                  id="exteriorDesign"
                />
                <span class="rating-value" id="exteriorDesignValue">5</span>
              </div>
            </div>
            <div class="form-group">
              <label>åšå·¥è´¨é‡</label>
              <div class="rating-container">
                <input
                  type="range"
                  class="rating-slider"
                  min="1"
                  max="10"
                  value="5"
                  id="exteriorQuality"
                />
                <span class="rating-value" id="exteriorQualityValue">5</span>
              </div>
            </div>
            <div class="form-group">
              <label>å¤–è§‚å¤‡æ³¨</label>
              <textarea id="exteriorNotes"></textarea>
            </div>
            <div class="media-buttons">
              <button class="media-button take-photo">
                <i>ğŸ“·</i> æ‹ç…§è®°å½•
              </button>
              <button
                class="media-button voice-note"
                data-target="exteriorNotes"
              >
                <i>ğŸ¤</i> è¯­éŸ³è®°å½•
              </button>
            </div>
            <div class="media-preview" id="exteriorPhotos"></div>
          </div>

          <!-- å…¶ä»–é€‰é¡¹å¡å†…å®¹ç±»ä¼¼ç»“æ„ï¼Œç•¥å»è¯¦ç»†å®ç° -->
        </div>

        <div class="card">
          <div class="card-title">ä¼˜ç¼ºç‚¹è®°å½•</div>
          <div class="advantage-disadvantage">
            <div class="advantage-container">
              <label>ä¼˜ç‚¹</label>
              <div class="tag-container" id="advantageTags"></div>
              <div class="add-tag-input">
                <input type="text" id="advantageInput" placeholder="æ·»åŠ ä¼˜ç‚¹" />
                <button id="addAdvantageBtn">æ·»åŠ </button>
              </div>
            </div>
            <div class="disadvantage-container">
              <label>ç¼ºç‚¹</label>
              <div class="tag-container" id="disadvantageTags"></div>
              <div class="add-tag-input">
                <input
                  type="text"
                  id="disadvantageInput"
                  placeholder="æ·»åŠ ç¼ºç‚¹"
                />
                <button id="addDisadvantageBtn">æ·»åŠ </button>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-title">ç»¼åˆè¯„ä»·</div>
          <div class="form-group">
            <label>æ€»ä½“è¯„åˆ†</label>
            <div class="rating-container">
              <input
                type="range"
                class="rating-slider"
                min="1"
                max="10"
                value="5"
                id="overallRating"
              />
              <span class="rating-value" id="overallRatingValue">5</span>
            </div>
          </div>
          <div class="form-group">
            <label>ä¸ªäººæ„Ÿå—ä¸è¯„ä»·</label>
            <textarea id="overallComments"></textarea>
          </div>
          <div class="media-buttons">
            <button
              class="media-button voice-note"
              data-target="overallComments"
            >
              <i>ğŸ¤</i> è¯­éŸ³è®°å½•
            </button>
          </div>
          <div class="action-buttons">
            <button class="action-button secondary-button" id="cancelRecordBtn">
              å–æ¶ˆ
            </button>
            <button class="action-button primary-button" id="saveRecordBtn">
              ä¿å­˜è®°å½•
            </button>
          </div>
        </div>
      </div>

      <div id="compareView" class="view" style="display: none">
        <div class="card">
          <div class="card-title">è½¦å‹å¯¹æ¯”</div>
          <label>é€‰æ‹©è¦å¯¹æ¯”çš„è½¦å‹(æœ€å¤š3ä¸ª)</label>
          <div class="car-select-container" id="compareCarSelect">
            <!-- è½¦è¾†é€‰æ‹©å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
          </div>
          <div id="comparisonTable" class="comparison-table-container">
            <!-- å¯¹æ¯”è¡¨æ ¼å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
          </div>
          <div id="radarChartContainer" class="radar-chart-container">
            <!-- é›·è¾¾å›¾å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
          </div>
          <div class="action-buttons">
            <button
              class="action-button primary-button"
              id="exportComparisonBtn"
            >
              å¯¼å‡ºå¯¹æ¯”æŠ¥å‘Š
            </button>
          </div>
        </div>
      </div>
    </main>

    <!-- åº•éƒ¨å¯¼èˆª -->
    <div class="footer-nav">
      <a href="#" class="nav-item active" data-view="homeView">
        <i>ğŸ </i>
        <span>é¦–é¡µ</span>
      </a>
      <a href="#" class="nav-item" data-view="compareView">
        <i>ğŸ“Š</i>
        <span>å¯¹æ¯”</span>
      </a>
      <a href="#" class="nav-item" id="addCarNav">
        <i>â•</i>
        <span>æ·»åŠ è½¦å‹</span>
      </a>
    </div>

    <!-- è¯­éŸ³è¯†åˆ«æ¨¡æ€æ¡† -->
    <div class="modal" id="voiceModal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">è¯­éŸ³è¯†åˆ«</h3>
          <button class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
          <div id="voiceStatus">ç‚¹å‡»å¼€å§‹å½•éŸ³æŒ‰é’®å¼€å§‹</div>
          <div
            id="voiceResult"
            style="
              margin-top: 15px;
              min-height: 100px;
              border: 1px solid var(--border-color);
              padding: 10px;
              border-radius: 4px;
            "
          ></div>
        </div>
        <div class="modal-footer">
          <button class="action-button primary-button" id="startVoiceBtn">
            å¼€å§‹å½•éŸ³
          </button>
          <button class="action-button secondary-button" id="cancelVoiceBtn">
            å–æ¶ˆ
          </button>
          <button class="action-button primary-button" id="confirmVoiceBtn">
            ç¡®è®¤
          </button>
        </div>
      </div>
    </div>

    <!-- æ‹ç…§æ¨¡æ€æ¡† -->
    <div class="modal" id="photoModal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">æ‹ç…§è®°å½•</h3>
          <button class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
          <video
            id="cameraPreview"
            style="width: 100%; max-height: 300px; background: #000"
            autoplay
          ></video>
          <canvas id="photoCanvas" style="display: none"></canvas>
          <div id="capturedPhoto" style="margin-top: 15px; display: none">
            <img id="photoResult" style="width: 100%; border-radius: 4px" />
          </div>
        </div>
        <div class="modal-footer">
          <button class="action-button primary-button" id="capturePhotoBtn">
            æ‹ç…§
          </button>
          <button
            class="action-button secondary-button"
            id="retakePhotoBtn"
            style="display: none"
          >
            é‡æ‹
          </button>
          <button class="action-button secondary-button" id="cancelPhotoBtn">
            å–æ¶ˆ
          </button>
          <button
            class="action-button primary-button"
            id="confirmPhotoBtn"
            style="display: none"
          >
            ç¡®è®¤
          </button>
        </div>
      </div>
    </div>

    <script>
      // å½“å‰è½¦è¾†æ•°æ®
      let currentCarData = {
        id: null,
        basic: {},
        ratings: {
          exterior: {},
          interior: {},
          space: {},
          driving: {},
          nvh: {},
          smart: {},
        },
        advantages: [],
        disadvantages: [],
        overall: {},
        photos: [],
      };

      // æ‰€æœ‰è½¦è¾†æ•°æ®
      let allCarsData = [];

      // å½“å‰é€‰æ‹©çš„æ–‡æœ¬è¾“å…¥åŒºåŸŸï¼ˆç”¨äºè¯­éŸ³è¯†åˆ«ï¼‰
      let currentVoiceTarget = null;

      // DOMåŠ è½½å®Œæˆåæ‰§è¡Œ
      document.addEventListener("DOMContentLoaded", function () {
        // åˆå§‹åŒ–æ•°æ®
        loadData();
        renderCarList();

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        setupEventListeners();
        setupRatingSliders();
        setupTabSwitching();
      });

      // åŠ è½½æœ¬åœ°å­˜å‚¨çš„æ•°æ®
      function loadData() {
        const savedData = localStorage.getItem("carTestDriveData");
        if (savedData) {
          try {
            allCarsData = JSON.parse(savedData);
          } catch (e) {
            console.error("Error parsing saved data:", e);
            allCarsData = [];
          }
        }
      }

      // ä¿å­˜æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨
      function saveData() {
        localStorage.setItem("carTestDriveData", JSON.stringify(allCarsData));
      }

      // æ¸²æŸ“è½¦è¾†åˆ—è¡¨
      function renderCarList() {
        const carListElement = document.getElementById("carList");
        carListElement.innerHTML = "";

        if (allCarsData.length === 0) {
          carListElement.innerHTML =
            "<p>æš‚æ— è¯•é©¾è®°å½•ï¼Œç‚¹å‡»æ·»åŠ æ–°è½¦å‹å¼€å§‹è®°å½•ã€‚</p>";
          return;
        }

        allCarsData.forEach((car) => {
          const carItem = document.createElement("div");
          carItem.className = "car-item";
          carItem.innerHTML = `
                    <div style="padding: 15px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h3 style="margin-bottom: 5px;">${
                              car.basic.carBrand || ""
                            } ${car.basic.carModel || ""} ${
            car.basic.carTrim || ""
          }</h3>
                            <p style="color: #666; font-size: 0.9rem; margin: 0;">
                                ${
                                  car.basic.testDriveDate
                                    ? `è¯•é©¾æ—¥æœŸ: ${car.basic.testDriveDate}`
                                    : ""
                                }
                                ${
                                  car.overall.overallRating
                                    ? ` | æ€»è¯„åˆ†: ${car.overall.overallRating}/10`
                                    : ""
                                }
                            </p>
                        </div>
                        <div>
                            <button class="action-button secondary-button edit-car-btn" data-id="${
                              car.id
                            }" style="margin-right: 5px;">ç¼–è¾‘</button>
                            <button class="action-button secondary-button delete-car-btn" data-id="${
                              car.id
                            }">åˆ é™¤</button>
                        </div>
                    </div>
                `;
          carListElement.appendChild(carItem);
        });

        // ä¸ºæŒ‰é’®æ·»åŠ äº‹ä»¶ç›‘å¬
        document.querySelectorAll(".edit-car-btn").forEach((btn) => {
          btn.addEventListener("click", function () {
            const carId = this.getAttribute("data-id");
            editCar(carId);
          });
        });

        document.querySelectorAll(".delete-car-btn").forEach((btn) => {
          btn.addEventListener("click", function () {
            const carId = this.getAttribute("data-id");
            deleteCar(carId);
          });
        });
      }

      // è®¾ç½®è¯„åˆ†æ»‘å—äº‹ä»¶
      function setupRatingSliders() {
        const sliders = document.querySelectorAll(".rating-slider");
        sliders.forEach((slider) => {
          const valueDisplay = document.getElementById(slider.id + "Value");
          slider.addEventListener("input", function () {
            valueDisplay.textContent = this.value;
          });
        });
      }

      // è®¾ç½®æ ‡ç­¾é¡µåˆ‡æ¢
      function setupTabSwitching() {
        const tabs = document.querySelectorAll(".tab");
        tabs.forEach((tab) => {
          tab.addEventListener("click", function () {
            const tabName = this.getAttribute("data-tab");

            // æ›´æ–°tabæ ·å¼
            document
              .querySelectorAll(".tab")
              .forEach((t) => t.classList.remove("active"));
            this.classList.add("active");

            // æ˜¾ç¤ºå¯¹åº”çš„å†…å®¹
            document
              .querySelectorAll(".tab-content")
              .forEach((content) => content.classList.remove("active"));
            document.getElementById(tabName + "Tab").classList.add("active");
          });
        });
      }

      // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
      function setupEventListeners() {
        // é¡¶éƒ¨å¯¼èˆªæŒ‰é’®
        document
          .getElementById("toggleTheme")
          .addEventListener("click", toggleTheme);
        document
          .getElementById("exportData")
          .addEventListener("click", exportAllData);

        // åº•éƒ¨å¯¼èˆª
        document.querySelectorAll(".footer-nav .nav-item").forEach((item) => {
          item.addEventListener("click", function (e) {
            e.preventDefault();
            const viewId = this.getAttribute("data-view");
            switchView(viewId);

            // æ›´æ–°å¯¼èˆªçŠ¶æ€
            document
              .querySelectorAll(".footer-nav .nav-item")
              .forEach((navItem) => {
                navItem.classList.remove("active");
              });
            this.classList.add("active");
          });
        });

        // æ·»åŠ æ–°è½¦å‹æŒ‰é’®
        document
          .getElementById("addNewCarBtn")
          .addEventListener("click", () => {
            resetCarForm();
            switchView("recordView");
          });

        document.getElementById("addCarNav").addEventListener("click", (e) => {
          e.preventDefault();
          resetCarForm();
          switchView("recordView");

          // æ›´æ–°å¯¼èˆªçŠ¶æ€
          document
            .querySelectorAll(".footer-nav .nav-item")
            .forEach((navItem) => {
              navItem.classList.remove("active");
            });
        });

        // è®°å½•è¡¨å•æŒ‰é’®
        document
          .getElementById("saveRecordBtn")
          .addEventListener("click", saveCarRecord);
        document
          .getElementById("cancelRecordBtn")
          .addEventListener("click", () => {
            switchView("homeView");
            document
              .querySelector('.nav-item[data-view="homeView"]')
              .classList.add("active");
          });

        // ä¼˜ç¼ºç‚¹æ ‡ç­¾æ·»åŠ 
        document
          .getElementById("addAdvantageBtn")
          .addEventListener("click", () => {
            addTag("advantage");
          });

        document
          .getElementById("addDisadvantageBtn")
          .addEventListener("click", () => {
            addTag("disadvantage");
          });

        // æ‹ç…§æŒ‰é’®
        document.querySelectorAll(".take-photo").forEach((btn) => {
          btn.addEventListener("click", openCameraModal);
        });

        // è¯­éŸ³å½•å…¥æŒ‰é’®
        document.querySelectorAll(".voice-note").forEach((btn) => {
          btn.addEventListener("click", function () {
            currentVoiceTarget = this.getAttribute("data-target");
            openVoiceModal();
          });
        });

        // æ¨¡æ€æ¡†å…³é—­æŒ‰é’®
        document.querySelectorAll(".modal-close").forEach((btn) => {
          btn.addEventListener("click", function () {
            const modal = this.closest(".modal");
            closeModal(modal.id);
          });
        });

        // è¯­éŸ³è¯†åˆ«æ¨¡æ€æ¡†æŒ‰é’®
        document
          .getElementById("startVoiceBtn")
          .addEventListener("click", startVoiceRecognition);
        document
          .getElementById("cancelVoiceBtn")
          .addEventListener("click", () => {
            closeModal("voiceModal");
          });
        document
          .getElementById("confirmVoiceBtn")
          .addEventListener("click", confirmVoiceInput);

        // æ‹ç…§æ¨¡æ€æ¡†æŒ‰é’®
        document
          .getElementById("capturePhotoBtn")
          .addEventListener("click", capturePhoto);
        document
          .getElementById("retakePhotoBtn")
          .addEventListener("click", retakePhoto);
        document
          .getElementById("cancelPhotoBtn")
          .addEventListener("click", () => {
            closeCamera();
            closeModal("photoModal");
          });
        document
          .getElementById("confirmPhotoBtn")
          .addEventListener("click", confirmPhoto);

        // å¯¹æ¯”æŠ¥å‘Šå¯¼å‡ºæŒ‰é’®
        document
          .getElementById("exportComparisonBtn")
          .addEventListener("click", exportComparisonReport);
      }

      // åˆ‡æ¢è§†å›¾
      function switchView(viewId) {
        document.querySelectorAll(".view").forEach((view) => {
          view.style.display = "none";
        });
        document.getElementById(viewId).style.display = "block";

        // å¦‚æœåˆ‡æ¢åˆ°å¯¹æ¯”è§†å›¾ï¼Œåˆå§‹åŒ–å¯¹æ¯”æ•°æ®
        if (viewId === "compareView") {
          initCompareView();
        }
      }

      // åˆ‡æ¢ä¸»é¢˜
      function toggleTheme() {
        const isDark = document.body.getAttribute("data-theme") === "dark";
        if (isDark) {
          document.body.removeAttribute("data-theme");
        } else {
          document.body.setAttribute("data-theme", "dark");
        }
        localStorage.setItem("theme", isDark ? "light" : "dark");
      }

      // é‡ç½®è½¦è¾†è¡¨å•
      function resetCarForm() {
        currentCarData = {
          id: Date.now().toString(),
          basic: {},
          ratings: {
            exterior: {},
            interior: {},
            space: {},
            driving: {},
            nvh: {},
            smart: {},
          },
          advantages: [],
          disadvantages: [],
          overall: {},
          photos: [],
        };

        // é‡ç½®è¡¨å•å…ƒç´ 
        document.getElementById("carInfoForm").reset();
        document.querySelectorAll(".rating-slider").forEach((slider) => {
          slider.value = 5;
          const valueDisplay = document.getElementById(slider.id + "Value");
          if (valueDisplay) valueDisplay.textContent = "5";
        });

        document.querySelectorAll("textarea").forEach((textarea) => {
          textarea.value = "";
        });

        document.getElementById("advantageTags").innerHTML = "";
        document.getElementById("disadvantageTags").innerHTML = "";

        // é‡ç½®åª’ä½“é¢„è§ˆ
        document.querySelectorAll(".media-preview").forEach((preview) => {
          preview.innerHTML = "";
        });
      }

      // ç¼–è¾‘è½¦è¾†
      function editCar(carId) {
        const car = allCarsData.find((car) => car.id === carId);
        if (!car) return;

        currentCarData = JSON.parse(JSON.stringify(car)); // æ·±æ‹·è´

        // å¡«å……è¡¨å•
        // åŸºæœ¬ä¿¡æ¯
        for (const key in car.basic) {
          const input = document.getElementById(key);
          if (input) input.value = car.basic[key] || "";
        }

        // è¯„åˆ†
        for (const category in car.ratings) {
          for (const key in car.ratings[category]) {
            const slider = document.getElementById(key);
            const valueDisplay = document.getElementById(key + "Value");
            if (slider) {
              slider.value = car.ratings[category][key] || 5;
              if (valueDisplay) valueDisplay.textContent = slider.value;
            }

            // å¡«å……å¤‡æ³¨
            const notes = document.getElementById(category + "Notes");
            if (notes && car.ratings[category][category + "Notes"]) {
              notes.value = car.ratings[category][category + "Notes"];
            }
          }
        }

        // ä¼˜ç¼ºç‚¹
        renderTags("advantage", car.advantages);
        renderTags("disadvantage", car.disadvantages);

        // ç»¼åˆè¯„ä»·
        if (car.overall) {
          const overallRating = document.getElementById("overallRating");
          const overallRatingValue =
            document.getElementById("overallRatingValue");
          const overallComments = document.getElementById("overallComments");

          if (overallRating)
            overallRating.value = car.overall.overallRating || 5;
          if (overallRatingValue)
            overallRatingValue.textContent = car.overall.overallRating || 5;
          if (overallComments)
            overallComments.value = car.overall.overallComments || "";
        }

        // ç…§ç‰‡
        if (car.photos && car.photos.length) {
          car.photos.forEach((photo) => {
            if (photo.category) {
              const container = document.getElementById(
                photo.category + "Photos"
              );
              if (container) {
                addPhotoToPreview(container, photo.dataUrl);
              }
            }
          });
        }

        // åˆ‡æ¢åˆ°è®°å½•è§†å›¾
        switchView("recordView");
      }

      // åˆ é™¤è½¦è¾†
      function deleteCar(carId) {
        if (confirm("ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚")) {
          allCarsData = allCarsData.filter((car) => car.id !== carId);
          saveData();
          renderCarList();
        }
      }

      // æ·»åŠ æ ‡ç­¾
      function addTag(type) {
        const inputElement = document.getElementById(type + "Input");
        const text = inputElement.value.trim();

        if (text) {
          const tags =
            type === "advantage"
              ? currentCarData.advantages
              : currentCarData.disadvantages;

          // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒæ ‡ç­¾
          if (!tags.includes(text)) {
            tags.push(text);
            renderTags(type, tags);
            inputElement.value = "";
          }
        }
      }

      // æ¸²æŸ“æ ‡ç­¾
      function renderTags(type, tags) {
        const container = document.getElementById(type + "Tags");
        container.innerHTML = "";

        tags.forEach((tag, index) => {
          const tagElement = document.createElement("div");
          tagElement.className = `tag ${type}-tag`;
          tagElement.innerHTML = `
                    <span>${tag}</span>
                    <span class="delete-tag" data-index="${index}">Ã—</span>
                `;
          container.appendChild(tagElement);
        });

        // æ·»åŠ åˆ é™¤æ ‡ç­¾äº‹ä»¶
        container.querySelectorAll(".delete-tag").forEach((btn) => {
          btn.addEventListener("click", function () {
            const index = parseInt(this.getAttribute("data-index"));
            if (type === "advantage") {
              currentCarData.advantages.splice(index, 1);
              renderTags("advantage", currentCarData.advantages);
            } else {
              currentCarData.disadvantages.splice(index, 1);
              renderTags("disadvantage", currentCarData.disadvantages);
            }
          });
        });
      }

      // ä¿å­˜è½¦è¾†è®°å½•
      function saveCarRecord() {
        // æ”¶é›†åŸºæœ¬ä¿¡æ¯
        const formElements = document.getElementById("carInfoForm").elements;
        for (let i = 0; i < formElements.length; i++) {
          const element = formElements[i];
          if (element.name) {
            currentCarData.basic[element.name] = element.value;
          }
        }

        // æ”¶é›†è¯„åˆ†æ•°æ®
        const categories = [
          "exterior",
          "interior",
          "space",
          "driving",
          "nvh",
          "smart",
        ];
        categories.forEach((category) => {
          // æ”¶é›†æ•°å€¼è¯„åˆ†
          document
            .querySelectorAll(`#${category}Tab .rating-slider`)
            .forEach((slider) => {
              currentCarData.ratings[category][slider.id] = parseInt(
                slider.value
              );
            });

          // æ”¶é›†å¤‡æ³¨
          const notes = document.getElementById(`${category}Notes`);
          if (notes) {
            currentCarData.ratings[category][`${category}Notes`] = notes.value;
          }
        });

        // æ”¶é›†ç»¼åˆè¯„ä»·
        currentCarData.overall = {
          overallRating: parseInt(
            document.getElementById("overallRating").value
          ),
          overallComments: document.getElementById("overallComments").value,
        };

        // æŸ¥æ‰¾æ˜¯å¦å·²å­˜åœ¨è¯¥è½¦è¾†è®°å½•
        const existingIndex = allCarsData.findIndex(
          (car) => car.id === currentCarData.id
        );

        if (existingIndex >= 0) {
          // æ›´æ–°ç°æœ‰è®°å½•
          allCarsData[existingIndex] = JSON.parse(
            JSON.stringify(currentCarData)
          );
        } else {
          // æ·»åŠ æ–°è®°å½•
          allCarsData.push(JSON.parse(JSON.stringify(currentCarData)));
        }

        // ä¿å­˜æ•°æ®
        saveData();

        // è¿”å›é¦–é¡µå¹¶åˆ·æ–°è½¦è¾†åˆ—è¡¨
        switchView("homeView");
        renderCarList();

        // æ›´æ–°åº•éƒ¨å¯¼èˆªçŠ¶æ€
        document.querySelectorAll(".footer-nav .nav-item").forEach((item) => {
          item.classList.remove("active");
        });
        document
          .querySelector('.nav-item[data-view="homeView"]')
          .classList.add("active");
      }

      // æ‰“å¼€è¯­éŸ³è¯†åˆ«æ¨¡æ€æ¡†
      function openVoiceModal() {
        document.getElementById("voiceModal").style.display = "flex";
        document.getElementById("voiceResult").textContent = "";
        document.getElementById("voiceStatus").textContent =
          "ç‚¹å‡»å¼€å§‹å½•éŸ³æŒ‰é’®å¼€å§‹";
      }

      // å¼€å§‹è¯­éŸ³è¯†åˆ«
      function startVoiceRecognition() {
        if (!("webkitSpeechRecognition" in window)) {
          alert("æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«åŠŸèƒ½ï¼Œè¯·ä½¿ç”¨Chromeæµè§ˆå™¨ã€‚");
          return;
        }

        const recognition = new webkitSpeechRecognition();
        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.lang = "zh-CN";

        let finalTranscript = "";

        recognition.onstart = function () {
          document.getElementById("voiceStatus").textContent = "æ­£åœ¨å½•éŸ³...";
          document.getElementById("startVoiceBtn").textContent = "åœæ­¢å½•éŸ³";
          document.getElementById("startVoiceBtn").onclick = function () {
            recognition.stop();
          };
        };

        recognition.onresult = function (event) {
          let interimTranscript = "";

          for (let i = event.resultIndex; i < event.results.length; ++i) {
            if (event.results[i].isFinal) {
              finalTranscript += event.results[i][0].transcript;
            } else {
              interimTranscript += event.results[i][0].transcript;
            }
          }

          document.getElementById("voiceResult").innerHTML =
            finalTranscript +
            '<span style="color:#999">' +
            interimTranscript +
            "</span>";
        };

        recognition.onerror = function (event) {
          console.error("Speech recognition error", event.error);
          document.getElementById("voiceStatus").textContent =
            "é”™è¯¯: " + event.error;
          resetVoiceUI();
        };

        recognition.onend = function () {
          resetVoiceUI();
        };

        function resetVoiceUI() {
          document.getElementById("voiceStatus").textContent = "å½•éŸ³å·²ç»“æŸ";
          document.getElementById("startVoiceBtn").textContent = "å¼€å§‹å½•éŸ³";
          document.getElementById("startVoiceBtn").onclick =
            startVoiceRecognition;
        }

        recognition.start();
      }

      // ç¡®è®¤è¯­éŸ³è¾“å…¥
      function confirmVoiceInput() {
        const text = document.getElementById("voiceResult").textContent.trim();

        if (text && currentVoiceTarget) {
          const targetElement = document.getElementById(currentVoiceTarget);
          if (targetElement) {
            // è¿½åŠ åˆ°ç°æœ‰å†…å®¹
            targetElement.value = targetElement.value
              ? targetElement.value + "\n" + text
              : text;
          }
        }

        closeModal("voiceModal");
      }

      // æ‰“å¼€ç›¸æœºæ¨¡æ€æ¡†
      function openCameraModal() {
        document.getElementById("photoModal").style.display = "flex";
        document.getElementById("capturePhotoBtn").style.display = "block";
        document.getElementById("retakePhotoBtn").style.display = "none";
        document.getElementById("confirmPhotoBtn").style.display = "none";
        document.getElementById("capturedPhoto").style.display = "none";
        document.getElementById("cameraPreview").style.display = "block";

        // è·å–å½“å‰æ ‡ç­¾é¡µ
        const activeTab = document
          .querySelector(".tab.active")
          .getAttribute("data-tab");
        currentPhotoCategory = activeTab;

        // å¼€å¯æ‘„åƒå¤´
        startCamera();
      }

      // å¯åŠ¨æ‘„åƒå¤´
      function startCamera() {
        const constraints = {
          video: {
            width: { ideal: 1280 },
            height: { ideal: 720 },
            facingMode: "environment",
          },
        };

        const video = document.getElementById("cameraPreview");

        navigator.mediaDevices
          .getUserMedia(constraints)
          .then(function (stream) {
            window.currentStream = stream;
            video.srcObject = stream;
          })
          .catch(function (err) {
            console.error("å¯åŠ¨æ‘„åƒå¤´å¤±è´¥:", err);
            alert("æ— æ³•è®¿é—®æ‘„åƒå¤´ï¼Œè¯·ç¡®ä¿å·²æˆäºˆæƒé™ã€‚");
            closeModal("photoModal");
          });
      }

      // å…³é—­æ‘„åƒå¤´
      function closeCamera() {
        if (window.currentStream) {
          window.currentStream.getTracks().forEach((track) => {
            track.stop();
          });
        }
      }

      // æ‹ç…§
      function capturePhoto() {
        const video = document.getElementById("cameraPreview");
        const canvas = document.getElementById("photoCanvas");
        const photo = document.getElementById("photoResult");

        // è®¾ç½®ç”»å¸ƒå°ºå¯¸
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        // å°†è§†é¢‘å¸§ç»˜åˆ¶åˆ°ç”»å¸ƒ
        const context = canvas.getContext("2d");
        context.drawImage(video, 0, 0, canvas.width, canvas.height);

        // å°†ç”»å¸ƒè½¬æ¢ä¸ºå›¾ç‰‡URL
        const dataUrl = canvas.toDataURL("image/jpeg");
        photo.src = dataUrl;

        // æ˜¾ç¤ºå›¾ç‰‡é¢„è§ˆï¼Œéšè—è§†é¢‘
        document.getElementById("capturedPhoto").style.display = "block";
        document.getElementById("cameraPreview").style.display = "none";

        // æ˜¾ç¤ºç¡®è®¤å’Œé‡æ‹æŒ‰é’®ï¼Œéšè—æ‹ç…§æŒ‰é’®
        document.getElementById("capturePhotoBtn").style.display = "none";
        document.getElementById("retakePhotoBtn").style.display = "block";
        document.getElementById("confirmPhotoBtn").style.display = "block";
      }

      // é‡æ–°æ‹ç…§
      function retakePhoto() {
        document.getElementById("capturedPhoto").style.display = "none";
        document.getElementById("cameraPreview").style.display = "block";
        document.getElementById("capturePhotoBtn").style.display = "block";
        document.getElementById("retakePhotoBtn").style.display = "none";
        document.getElementById("confirmPhotoBtn").style.display = "none";
      }

      // ç¡®è®¤æ‹ç…§
      function confirmPhoto() {
        const dataUrl = document.getElementById("photoResult").src;

        // ä¿å­˜ç…§ç‰‡æ•°æ®
        currentCarData.photos.push({
          category: currentPhotoCategory,
          dataUrl: dataUrl,
        });

        // åœ¨ç•Œé¢ä¸Šæ˜¾ç¤ºç…§ç‰‡é¢„è§ˆ
        const previewContainer = document.getElementById(
          currentPhotoCategory + "Photos"
        );
        if (previewContainer) {
          addPhotoToPreview(previewContainer, dataUrl);
        }

        // å…³é—­ç›¸æœºå’Œæ¨¡æ€æ¡†
        closeCamera();
        closeModal("photoModal");
      }

      // æ·»åŠ ç…§ç‰‡åˆ°é¢„è§ˆåŒºåŸŸ
      function addPhotoToPreview(container, dataUrl) {
        const mediaItem = document.createElement("div");
        mediaItem.className = "media-item";
        mediaItem.innerHTML = `
                <img src="${dataUrl}">
                <button class="delete-btn">Ã—</button>
            `;
        container.appendChild(mediaItem);

        // æ·»åŠ åˆ é™¤æŒ‰é’®äº‹ä»¶
        const deleteBtn = mediaItem.querySelector(".delete-btn");
        deleteBtn.addEventListener("click", function () {
          // ä»æ•°æ®ä¸­ç§»é™¤ç…§ç‰‡
          const category = container.id.replace("Photos", "");
          currentCarData.photos = currentCarData.photos.filter(
            (photo) =>
              !(photo.category === category && photo.dataUrl === dataUrl)
          );

          // ä»ç•Œé¢ç§»é™¤é¢„è§ˆ
          container.removeChild(mediaItem);
        });
      }

      // å…³é—­æ¨¡æ€æ¡†
      function closeModal(modalId) {
        document.getElementById(modalId).style.display = "none";

        // å¦‚æœæ˜¯ç›¸æœºæ¨¡æ€æ¡†ï¼Œå…³é—­ç›¸æœº
        if (modalId === "photoModal") {
          closeCamera();
        }
      }

      // åˆå§‹åŒ–å¯¹æ¯”è§†å›¾
      function initCompareView() {
        const selectContainer = document.getElementById("compareCarSelect");
        selectContainer.innerHTML = "";

        // æ·»åŠ è½¦è¾†é€‰æ‹©é€‰é¡¹
        allCarsData.forEach((car) => {
          const carSelectItem = document.createElement("div");
          carSelectItem.className = "car-select-item";
          carSelectItem.setAttribute("data-id", car.id);
          carSelectItem.textContent = `${car.basic.carBrand || ""} ${
            car.basic.carModel || ""
          } ${car.basic.carTrim || ""}`;
          selectContainer.appendChild(carSelectItem);

          // æ·»åŠ ç‚¹å‡»äº‹ä»¶
          carSelectItem.addEventListener("click", function () {
            this.classList.toggle("selected");
            updateComparisonTable();
          });
        });
      }

      // æ›´æ–°å¯¹æ¯”è¡¨æ ¼
      function updateComparisonTable() {
        const selectedItems = document.querySelectorAll(
          ".car-select-item.selected"
        );
        const selectedIds = Array.from(selectedItems).map((item) =>
          item.getAttribute("data-id")
        );

        if (selectedIds.length === 0) {
          document.getElementById("comparisonTable").innerHTML =
            "<p>è¯·é€‰æ‹©è¦å¯¹æ¯”çš„è½¦å‹ï¼ˆæœ€å¤š3ä¸ªï¼‰</p>";
          document.getElementById("radarChartContainer").innerHTML = "";
          return;
        }

        // é™åˆ¶æœ€å¤šé€‰æ‹©3ä¸ªè½¦å‹
        if (selectedIds.length > 3) {
          alert("æœ€å¤šåªèƒ½å¯¹æ¯”3ä¸ªè½¦å‹");
          return;
        }

        // è·å–å·²é€‰è½¦å‹æ•°æ®
        const selectedCars = allCarsData.filter((car) =>
          selectedIds.includes(car.id)
        );

        // ç”Ÿæˆå¯¹æ¯”è¡¨æ ¼
        const tableContainer = document.getElementById("comparisonTable");
        tableContainer.innerHTML = "";

        const table = document.createElement("table");
        table.className = "comparison-table";

        // æ·»åŠ è¡¨å¤´
        const thead = document.createElement("thead");
        let headerRow = document.createElement("tr");
        headerRow.innerHTML = "<th>ç‰¹æ€§</th>";
        selectedCars.forEach((car) => {
          headerRow.innerHTML += `<th>${car.basic.carBrand || ""} ${
            car.basic.carModel || ""
          } ${car.basic.carTrim || ""}</th>`;
        });
        thead.appendChild(headerRow);
        table.appendChild(thead);

        // æ·»åŠ è¡¨æ ¼å†…å®¹
        const tbody = document.createElement("tbody");

        // åŸºæœ¬ä¿¡æ¯
        addComparisonSection(tbody, "åŸºæœ¬ä¿¡æ¯", selectedCars);

        // ä»·æ ¼ä¿¡æ¯
        addComparisonRow(tbody, "å®˜æ–¹æŒ‡å¯¼ä»·", selectedCars, (car) =>
          car.basic.msrp ? `${car.basic.msrp}ä¸‡å…ƒ` : "-"
        );
        addComparisonRow(tbody, "å®é™…æŠ¥ä»·", selectedCars, (car) =>
          car.basic.dealerPrice ? `${car.basic.dealerPrice}ä¸‡å…ƒ` : "-"
        );

        // è¯„åˆ†å¯¹æ¯”
        addComparisonSection(tbody, "è¯„åˆ†(1-10åˆ†)", selectedCars);

        // å¤–è§‚è¯„åˆ†
        addComparisonRow(
          tbody,
          "æ•´ä½“è®¾è®¡æ„Ÿ",
          selectedCars,
          (car) => car.ratings.exterior.exteriorDesign || "-"
        );
        addComparisonRow(
          tbody,
          "åšå·¥è´¨é‡",
          selectedCars,
          (car) => car.ratings.exterior.exteriorQuality || "-"
        );

        // å†…é¥°è¯„åˆ†
        addComparisonRow(
          tbody,
          "å†…é¥°è®¾è®¡",
          selectedCars,
          (car) => car.ratings.interior?.interiorDesign || "-"
        );
        addComparisonRow(
          tbody,
          "æè´¨è´¨æ„Ÿ",
          selectedCars,
          (car) => car.ratings.interior?.materialQuality || "-"
        );

        // ç©ºé—´è¯„åˆ†
        addComparisonRow(
          tbody,
          "å‰æ’ç©ºé—´",
          selectedCars,
          (car) => car.ratings.space?.frontSpace || "-"
        );
        addComparisonRow(
          tbody,
          "åæ’ç©ºé—´",
          selectedCars,
          (car) => car.ratings.space?.rearSpace || "-"
        );
        addComparisonRow(
          tbody,
          "è¡Œæå¢ç©ºé—´",
          selectedCars,
          (car) => car.ratings.space?.trunkSpace || "-"
        );

        // é©¾é©¶è¯„åˆ†
        addComparisonRow(
          tbody,
          "åŠ¨åŠ›è¡¨ç°",
          selectedCars,
          (car) => car.ratings.driving?.powerPerformance || "-"
        );
        addComparisonRow(
          tbody,
          "æ“æ§æ€§èƒ½",
          selectedCars,
          (car) => car.ratings.driving?.handling || "-"
        );
        addComparisonRow(
          tbody,
          "åˆ¹è½¦æ€§èƒ½",
          selectedCars,
          (car) => car.ratings.driving?.braking || "-"
        );
        addComparisonRow(
          tbody,
          "æ‚¬æŒ‚èˆ’é€‚æ€§",
          selectedCars,
          (car) => car.ratings.driving?.rideComfort || "-"
        );

        // å™ªéŸ³è¯„åˆ†
        addComparisonRow(
          tbody,
          "æ€ é€Ÿå™ªéŸ³",
          selectedCars,
          (car) => car.ratings.nvh?.idleNoise || "-"
        );
        addComparisonRow(
          tbody,
          "è¡Œé©¶å™ªéŸ³",
          selectedCars,
          (car) => car.ratings.nvh?.drivingNoise || "-"
        );

        // æ™ºèƒ½ç³»ç»Ÿè¯„åˆ†
        addComparisonRow(
          tbody,
          "è½¦æœºç³»ç»Ÿ",
          selectedCars,
          (car) => car.ratings.smart?.infotainment || "-"
        );
        addComparisonRow(
          tbody,
          "é©¾é©¶è¾…åŠ©",
          selectedCars,
          (car) => car.ratings.smart?.driverAssistance || "-"
        );

        // æ€»ä½“è¯„åˆ†
        addComparisonRow(
          tbody,
          "æ€»ä½“è¯„åˆ†",
          selectedCars,
          (car) => car.overall.overallRating || "-"
        );

        // ä¼˜ç¼ºç‚¹å¯¹æ¯”
        addComparisonSection(tbody, "ä¼˜ç¼ºç‚¹å¯¹æ¯”", selectedCars);
        addComparisonRow(
          tbody,
          "ä¼˜ç‚¹",
          selectedCars,
          (car) => car.advantages.join("ã€") || "-"
        );
        addComparisonRow(
          tbody,
          "ç¼ºç‚¹",
          selectedCars,
          (car) => car.disadvantages.join("ã€") || "-"
        );

        table.appendChild(tbody);
        tableContainer.appendChild(table);

        // ç”Ÿæˆé›·è¾¾å›¾
        generateRadarChart(selectedCars);
      }

      // æ·»åŠ å¯¹æ¯”è¡¨æ ¼ç« èŠ‚æ ‡é¢˜
      function addComparisonSection(tbody, title, cars) {
        const row = document.createElement("tr");
        row.innerHTML = `<td colspan="${
          cars.length + 1
        }" style="background-color: var(--secondary-color); color: white; font-weight: 500;">${title}</td>`;
        tbody.appendChild(row);
      }

      // æ·»åŠ å¯¹æ¯”è¡¨æ ¼è¡Œ
      function addComparisonRow(tbody, label, cars, valueGetter) {
        const row = document.createElement("tr");
        row.innerHTML = `<td>${label}</td>`;

        cars.forEach((car) => {
          row.innerHTML += `<td>${valueGetter(car)}</td>`;
        });

        tbody.appendChild(row);
      }

      // ç”Ÿæˆé›·è¾¾å›¾
      function generateRadarChart(selectedCars) {
        // æ³¨æ„ï¼šå®é™…é¡¹ç›®ä¸­ï¼Œåº”è¯¥ä½¿ç”¨Chart.jsç­‰åº“æ¥å®ç°é›·è¾¾å›¾
        // è¿™é‡Œä»…ä½œç¤ºæ„
        const container = document.getElementById("radarChartContainer");
        container.innerHTML =
          '<p style="text-align:center; padding: 20px;">é›·è¾¾å›¾éœ€è¦å¼•å…¥Chart.jsç­‰ç¬¬ä¸‰æ–¹åº“å®ç°ï¼Œè¿™é‡Œä»…ä½œç¤ºæ„ã€‚</p>';
      }

      // å¯¼å‡ºæ‰€æœ‰æ•°æ®
      function exportAllData() {
        const dataStr = JSON.stringify(allCarsData, null, 2);
        const dataBlob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(dataBlob);

        const a = document.createElement("a");
        a.href = url;
        a.download = `è½¦è¾†è¯•é©¾æ•°æ®_${
          new Date().toISOString().split("T")[0]
        }.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      // å¯¼å‡ºå¯¹æ¯”æŠ¥å‘Š
      function exportComparisonReport() {
        alert("å¯¹æ¯”æŠ¥å‘Šå¯¼å‡ºåŠŸèƒ½éœ€è¦å¼•å…¥ç¬¬ä¸‰æ–¹PDFç”Ÿæˆåº“ï¼Œå¦‚jsPDFç­‰å®ç°");
      }

      // åŠ è½½ä¸»é¢˜è®¾ç½®
      function loadThemePreference() {
        const savedTheme = localStorage.getItem("theme");
        if (savedTheme === "dark") {
          document.body.setAttribute("data-theme", "dark");
        }
      }

      // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–ä¸»é¢˜
      loadThemePreference();
    </script>
  </body>
</html>
